---
- name: Ansible playbook to deploy RHEM on Image Mode
  hosts: localhost
  gather_facts: yes
  vars_files:
  - vars/main.yaml
  tasks:
  - name: Install required packages
    ansible.builtin.package:
      name:
      - certbot
      - python3-certbot-dns-route53
      state: present

  - name: Ensure AWS credentials directory exists
    ansible.builtin.file:
      path: /root/.aws
      state: directory
      owner: root
      group: root
      mode: '0700'
  
  - name: Write AWS credentials for certbot
    ansible.builtin.copy:
      dest: /root/.aws/credentials
      content: |
        [default]
        aws_access_key_id={{ lookup('env', 'AWS_ACCESS_KEY_ID') }}
        aws_secret_access_key={{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}
      owner: root
      group: root
      mode: '0600'

  - name: Generate a certificate
    ansible.builtin.command: >
      certbot certonly --non-interactive --agree-tos
      --email {{ email }}
      --dns-route53
      -d {{ domain_name }}
    args:
      creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"

  - name: Show certificate location
    ansible.builtin.debug:
      msg: "Certificate installed at /etc/letsencrypt/live/{{ domain_name }}/"